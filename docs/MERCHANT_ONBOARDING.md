# 商家入驻流程文档

## 完整流程

### 1. 总台创建商家账户

**路径：** `/admin/merchants/create`

**操作步骤：**
1. 总台管理员登录总台后台
2. 进入"商家管理" → "添加新商家"
3. 填写商家信息：
   - 公司名称（必填）
   - 营业执照号（可选）
   - 联系人姓名（必填）
   - 联系邮箱（必填，将作为登录账号）
   - 联系电话（必填）
   - 地址信息（可选）
4. 点击"创建商家账户"

**系统自动执行：**
- 创建用户账户（Supabase Auth）
- 生成随机临时密码（16位，包含大小写字母、数字、特殊字符）
- 设置用户角色为 `merchant`
- 创建商家记录
- 创建默认商家设置
- 标记需要首次登录修改密码

**返回信息：**
- 登录邮箱
- 临时密码
- 登录地址

### 2. 发送登录凭证给商家

**方式（选择其一）：**

**方式A：手动发送**
- 总台管理员复制登录凭证
- 通过安全渠道（加密邮件、电话等）发送给商家

**方式B：自动邮件发送（待实现）**
- 系统自动发送包含登录凭证的邮件
- 邮件包含：
  - 登录链接
  - 临时密码
  - 首次登录说明

### 3. 商家首次登录

**路径：** `/merchant/login`

**流程：**
1. 商家访问登录页面
2. 输入邮箱和临时密码
3. 系统检测到首次登录（`needs_password_change = true`）
4. **强制跳转到修改密码页面**
5. 商家必须设置新密码（至少8个字符）
6. 密码修改成功后，自动登录并跳转到商家后台

### 4. 商家访问专属后台

**路径：** `/merchant`

**功能模块：**
- 仪表板：业务概览
- 产品管理：添加/编辑/管理产品
- 订单管理：查看/处理订单
- 客户管理：查看预订客户
- 数据分析：销售数据、趋势分析
- 设置：商家信息、通知设置、银行账户

### 5. 开始管理产品

商家可以：
- 添加新产品
- 编辑现有产品
- 管理产品库存（日期、名额）
- 设置价格日历
- 上架/下架产品

## 安全特性

### 数据隔离
- 每个商家只能看到自己的数据
- API自动过滤，防止数据泄露
- 数据库RLS策略双重保护

### 密码安全
- 临时密码随机生成
- 首次登录强制修改
- 密码强度验证（至少8个字符）

### 操作审计
- 所有敏感操作记录到 `audit_logs`
- 记录操作人、时间、IP地址
- 仅管理员可查看审计日志

### API安全
- JWT认证
- 角色权限验证
- 速率限制（防止暴力破解）
- 登录限制：15分钟内最多5次尝试

## 部署方案

### 方案A：子域名方式（推荐用于多租户）

```
merchant1.atockorea.com → 商家1后台
merchant2.atockorea.com → 商家2后台
```

**实现方式：**
- 根据子域名识别商家
- 共享同一套代码
- 通过中间件路由到对应商家数据

**优点：**
- 品牌独立性强
- 易于扩展
- SEO友好

**缺点：**
- 需要DNS配置
- SSL证书管理复杂

### 方案B：路径方式（当前实现）

```
atockorea.com/merchant → 商家后台
atockorea.com/admin → 总台后台
```

**实现方式：**
- 通过登录状态识别商家
- 使用 `merchant_id` 进行数据隔离

**优点：**
- 实现简单
- 维护成本低
- 适合中小规模

**缺点：**
- 品牌独立性较弱

### 方案C：独立部署（最高安全性）

每个商家单独部署一套系统

**优点：**
- 数据完全隔离
- 可定制化程度高
- 安全性最高

**缺点：**
- 成本高
- 维护复杂
- 不适合大规模

## 测试检查清单

### 数据隔离测试
- [ ] 商家A登录后只能看到自己的产品
- [ ] 商家A无法访问商家B的产品ID
- [ ] 商家A无法修改商家B的数据
- [ ] API返回的数据都包含正确的 `merchant_id`

### 权限测试
- [ ] 普通用户无法访问 `/merchant` 和 `/admin`
- [ ] 商家用户无法访问 `/admin`
- [ ] 管理员可以访问所有功能
- [ ] 未登录用户被重定向到登录页

### 业务流程测试
- [ ] 总台创建商家账户成功
- [ ] 商家使用临时密码登录成功
- [ ] 首次登录强制修改密码
- [ ] 商家创建产品自动分配 `merchant_id`
- [ ] 订单自动关联到正确的商家
- [ ] 商家只能看到自己产品的订单

### 安全测试
- [ ] 登录速率限制生效（5次/15分钟）
- [ ] 创建商家速率限制生效（10次/小时）
- [ ] 文件上传大小限制生效
- [ ] 敏感操作记录到审计日志
- [ ] 密码修改后旧密码失效

## 环境变量配置

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# App URL (for email links)
NEXT_PUBLIC_APP_URL=https://atockorea.com

# Email Service (for sending credentials)
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your_email@example.com
SMTP_PASSWORD=your_password
```

## 下一步开发

1. **邮件服务集成**
   - 集成 SendGrid / AWS SES
   - 发送登录凭证邮件
   - 发送订单通知邮件

2. **完善功能**
   - 产品库存管理
   - 价格日历
   - 订单导出
   - 数据分析图表

3. **移动端优化**
   - 响应式设计优化
   - 移动端专用界面

4. **多语言支持**
   - 国际化（i18n）
   - 支持英文、中文、韩文

5. **Webhook集成**
   - 订单状态变更通知
   - 支付成功通知
   - 库存预警通知

